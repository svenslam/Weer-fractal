<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Weer Fractals</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 20px;
    }
    canvas {
      border: 1px solid #555;
      background: #111;
    }
    .gallery {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px;
    }
    .gallery img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <h1>Weergebaseerde Fractals</h1>
  <p id="weatherInfo">Weerdata ophalen...</p>

  <div class="row">
    <div>
      <h3>Julia Set</h3>
      <canvas id="juliaCanvas" width="300" height="300"></canvas>
    </div>
    <div>
      <h3>Tree Fractal</h3>
      <canvas id="treeCanvas" width="300" height="300"></canvas>
    </div>
    <div>
      <h3>Koch Sneeuwvlok</h3>
      <canvas id="kochCanvas" width="300" height="300"></canvas>
    </div>
  </div>

  <h2>Laatste fractalsets</h2>
  <div class="gallery" id="gallery"></div>

  <script>
    const lat = 52.37, lon = 4.89;
    const weatherInfo = document.getElementById('weatherInfo');
    const juliaCtx = document.getElementById('juliaCanvas').getContext('2d');
    const treeCtx = document.getElementById('treeCanvas').getContext('2d');
    const kochCtx = document.getElementById('kochCanvas').getContext('2d');
    const gallery = document.getElementById('gallery');

    function map(value, inMin, inMax, outMin, outMax) {
      return outMin + (outMax - outMin) * ((value - inMin) / (inMax - inMin));
    }

    async function fetchWeather() {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,windspeed_10m`;
      const res = await fetch(url);
      const data = await res.json();
      const w = data.current;

      const temp = w.temperature_2m ?? 15;
      const wind = w.windspeed_10m ?? 5;
      const rain = w.precipitation ?? 0;

      weatherInfo.textContent = `Temp: ${temp}Â°C | Wind: ${wind} km/u | Neerslag: ${rain} mm`;

      drawAllFractals(temp, wind, rain);
    }

    function drawAllFractals(temp, wind, rain) {
      drawJulia(juliaCtx, temp, wind, rain);
      drawTree(treeCtx, temp, wind, rain);
      drawKoch(kochCtx, temp, wind, rain);
      saveFractals();
    }

    // --- JULIA SET ---
    function drawJulia(ctx, temp, wind, rain) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const imageData = ctx.createImageData(width, height);
      const data = imageData.data;
      const cRe = map(temp, -10, 35, -1.0, 1.0);
      const cIm = map(wind, 0, 50, -1.0, 1.0);
      const zoom = map(rain, 0, 10, 1.5, 0.5);
      const maxIter = 150;

      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          let zx = map(x, 0, width, -zoom, zoom);
          let zy = map(y, 0, height, -zoom, zoom);
          let i = 0;

          while (zx * zx + zy * zy < 4 && i < maxIter) {
            const tmp = zx * zx - zy * zy + cRe;
            zy = 2.0 * zx * zy + cIm;
            zx = tmp;
            i++;
          }

          const idx = (y * width + x) * 4;
          const color = i === maxIter ? 0 : 255 - Math.floor(i * 255 / maxIter);
          data[idx] = color;
          data[idx + 1] = color * 0.6;
          data[idx + 2] = color * 1.2;
          data[idx + 3] = 255;
        }
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // --- TREE FRACTAL ---
    function drawTree(ctx, temp, wind, rain) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.save();
      ctx.translate(ctx.canvas.width / 2, ctx.canvas.height);
      ctx.strokeStyle = `hsl(${temp * 10}, 80%, 60%)`;

      const depth = Math.floor(map(wind, 0, 30, 5, 10));
      const angle = map(temp, -10, 35, Math.PI / 10, Math.PI / 3);
      const length = map(rain, 0, 10, 40, 80);

      function branch(len, d) {
        if (d === 0) return;
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(0, -len);
        ctx.stroke();
        ctx.translate(0, -len);
        ctx.save();
        ctx.rotate(angle);
        branch(len * 0.7, d - 1);
        ctx.restore();
        ctx.save();
        ctx.rotate(-angle);
        branch(len * 0.7, d - 1);
        ctx.restore();
      }

      branch(length, depth);
      ctx.restore();
    }

    // --- KOCH SNOWFLAKE ---
    function drawKoch(ctx, temp, wind, rain) {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      const depth = Math.floor(map(wind, 0, 30, 0, 5));
      const size = map(temp, -10, 35, 100, 240);
      ctx.strokeStyle = `hsl(${rain * 36}, 100%, 70%)`;
      ctx.beginPath();

      const cx = ctx.canvas.width / 2;
      const cy = ctx.canvas.height / 2;
      const h = size * Math.sqrt(3) / 2;

      const p1 = [cx - size / 2, cy + h / 3];
      const p2 = [cx + size / 2, cy + h / 3];
      const p3 = [cx, cy - 2 * h / 3];

      drawKochLine(ctx, p1, p2, depth);
      drawKochLine(ctx, p2, p3, depth);
      drawKochLine(ctx, p3, p1, depth);
      ctx.stroke();
    }

    function drawKochLine(ctx, [x1, y1], [x2, y2], depth) {
      if (depth === 0) {
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        return;
      }

      const dx = (x2 - x1) / 3;
      const dy = (y2 - y1) / 3;
      const xA = x1 + dx;
      const yA = y1 + dy;
      const xB = x1 + 2 * dx;
      const yB = y1 + 2 * dy;

      const angle = Math.PI / 3;
      const xM = xA + Math.cos(angle) * dx - Math.sin(angle) * dy;
      const yM = yA + Math.sin(angle) * dx + Math.cos(angle) * dy;

      drawKochLine(ctx, [x1, y1], [xA, yA], depth - 1);
      drawKochLine(ctx, [xA, yA], [xM, yM], depth - 1);
      drawKochLine(ctx, [xM, yM], [xB, yB], depth - 1);
      drawKochLine(ctx, [xB, yB], [x2, y2], depth - 1);
    }

    // --- STORAGE ---
    function saveFractals() {
      const julia = document.getElementById('juliaCanvas').toDataURL();
      const tree = document.getElementById('treeCanvas').toDataURL();
      const koch = document.getElementById('kochCanvas').toDataURL();

      let sets = JSON.parse(localStorage.getItem("fractalSets") || "[]");
      sets.unshift({ julia, tree, koch });
      sets = sets.slice(0, 3);
      localStorage.setItem("fractalSets", JSON.stringify(sets));
      updateGallery(sets);
    }

    function updateGallery(sets) {
      gallery.innerHTML = "";
      sets.forEach(set => {
        ["julia", "tree", "koch"].forEach(type => {
          const img = document.createElement("img");
          img.src = set[type];
          gallery.appendChild(img);
        });
      });
    }

    // --- INIT ---
    const history = JSON.parse(localStorage.getItem("fractalSets") || "[]");
    if (history.length) updateGallery(history);
    fetchWeather();

    const now = new Date();
    const nextUpdate = new Date();
    nextUpdate.setHours(7, 0, 0, 0);
    if (now > nextUpdate) nextUpdate.setDate(nextUpdate.getDate() + 1);
    const timeout = nextUpdate - now;
    setTimeout(() => {
      fetchWeather();
      setInterval(fetchWeather, 24 * 60 * 60 * 1000);
    }, timeout);
  </script>
</body>
</html>
