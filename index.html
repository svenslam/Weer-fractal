<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weer Fractals</title>
<style>
body {
background: radial-gradient(circle at top, #111 0%, #000 100%);
color: #eee;
font-family: "Segoe UI", sans-serif;
text-align: center;
margin: 0;
padding: 0;
}
h1 { margin: 20px 0 10px; font-size: 1.8em; }
#weatherInfo { margin-bottom: 20px; color: #ccc; font-weight: 500; }
.row { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; padding: 10px; }
canvas {
border: 1px solid #444;
background: #111;
border-radius: 10px;
box-shadow: 0 0 10px rgba(255,255,255,0.05);
}
.gallery {
display: flex;
flex-direction: column;
align-items: center;
gap: 20px;
margin: 30px auto;
max-width: 95%;
}
.set {
display: flex;
flex-direction: column;
align-items: center;
gap: 8px;
background: rgba(255,255,255,0.05);
padding: 12px;
border-radius: 12px;
max-width: 300px;
width: 100%;
box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.set-header { width: 100%; font-size: 0.9em; color: #bbb; text-align: right; }
.set-values { width: 100%; font-size: 0.85em; color: #ddd; text-align: left; }
.set img { width: 100%; height: auto; border-radius: 8px; border: 1px solid #333; }
</style>
</head>
<body>
<h1>Weergebaseerde Julia Fractal</h1>
<p id="weatherInfo">Laden...</p>

<div class="row">
<canvas id="juliaCanvas" width="300" height="300"></canvas>
</div>

<h2>Laatste 20 dagen</h2>
<div class="gallery" id="gallery"></div>

<script>
const lat = 52.37, lon = 4.89;
const ctx = document.getElementById('juliaCanvas').getContext('2d');
const info = document.getElementById('weatherInfo');
const gallery = document.getElementById('gallery');

const map = (v, a, b, c, d) => c + (d - c) * ((v - a) / (b - a));

function hsvToRgb(h, s, v) {
const i = Math.floor(h * 6);
const f = h * 6 - i;
const p = v * (1 - s);
const q = v * (1 - f * s);
const t = v * (1 - (1 - f) * s);
let r, g, b;
switch (i % 6) {
case 0: r = v, g = t, b = p; break;
case 1: r = q, g = v, b = p; break;
case 2: r = p, g = v, b = t; break;
case 3: r = p, g = q, b = v; break;
case 4: r = t, g = p, b = v; break;
case 5: r = v, g = p, b = q; break;
}
return [Math.floor(r * 255), Math.floor(g * 255), Math.floor(b * 255)];
}

const drawJulia = (temp, wind, rain) => {
const w = ctx.canvas.width, h = ctx.canvas.height;
const img = ctx.createImageData(w, h);
const d = img.data;
const cRe = map(temp, -10, 35, -1.2, 0.3); // Geoptimaliseerd voor interessantere regio's
const cIm = map(wind, 0, 50, -0.8, 0.8);
const zoom = map(rain, 0, 10, 2.0, 0.5); // Breder zoombereik voor meer detail
const maxIter = 500; // Verhoogd voor betere resolutie

for (let y = 0; y < h; y++) {
for (let x = 0; x < w; x++) {
let zx = map(x, 0, w, -zoom, zoom);
let zy = map(y, 0, h, -zoom, zoom);
let i = 0;

while (zx * zx + zy * zy < 4 && i < maxIter) {
const tmp = zx * zx - zy * zy + cRe;
zy = 2 * zx * zy + cIm;
zx = tmp;
i++;
}

let idx = (y * w + x) * 4;
if (i === maxIter) {
d[idx] = d[idx+1] = d[idx+2] = 0; // Zwart voor binnen de set
d[idx+3] = 255;
} else {
// Smooth coloring
const mu = i + 1 - Math.log(Math.log(zx*zx + zy*zy) / 2) / Math.log(2);
const hue = (mu / maxIter) % 1;
const [r, g, b] = hsvToRgb(hue, 0.8, 1.0);
d[idx] = r; d[idx+1] = g; d[idx+2] = b; d[idx+3] = 255;
}
}
}
ctx.putImageData(img, 0, 0);
};

const fetchWeather = async () => {
const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,windspeed_10m`);
const { current: w } = await res.json();
return { temp: w.temperature_2m ?? 15, wind: w.windspeed_10m ?? 5, rain: w.precipitation ?? 0 };
};

const saveSet = (temp, wind, rain) => {
const dataUrl = ctx.canvas.toDataURL();
const date = new Date().toLocaleString('nl-NL', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
let sets = JSON.parse(localStorage.getItem('sets') || '[]');
sets.unshift({ date, dataUrl, temp, wind, rain });
if (sets.length > 20) sets.pop();
localStorage.setItem('sets', JSON.stringify(sets));
updateGallery(sets);
};

const updateGallery = sets => {
gallery.innerHTML = '';
sets.forEach(s => {
const div = document.createElement('div'); div.className = 'set';
const h = document.createElement('div'); h.className = 'set-header'; h.textContent = s.date;
const v = document.createElement('p'); v.className = 'set-values';
v.textContent = `Temp: ${s.temp}°C | Wind: ${s.wind} km/u | Neerslag: ${s.rain} mm`;
const img = new Image(); img.src = s.dataUrl;
div.append(h, v, img);
gallery.appendChild(div);
});
};

const init = async () => {
const sets = JSON.parse(localStorage.getItem('sets') || '[]');
if (sets.length) {
updateGallery(sets);
const latest = sets[0];
info.textContent = `Laatste: ${latest.date} – ${latest.temp}°C, ${latest.wind} km/u, ${latest.rain} mm`;
}

const now = new Date();
const today7am = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 0, 0);
const last = localStorage.getItem('last') ? new Date(+localStorage.getItem('last')) : new Date(0);

if (now >= today7am && last < today7am) {
const { temp, wind, rain } = await fetchWeather();
drawJulia(temp, wind, rain);
saveSet(temp, wind, rain);
localStorage.setItem('last', now.getTime().toString());
info.textContent = `Vandaag 07:00 – ${temp}°C, ${wind} km/u, ${rain} mm`;
}
};

init();
</script>
</body>
</html>
